generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// FOUNDATIONAL ENTITIES
// ============================================

model Language {
  id                String   @id @default(cuid())
  code              String   @unique // 'en', 'rw', 'umw'
  name              String   // 'English', 'Ikinyarwanda', 'Umwero'
  displayName       String   // For UI
  direction         String   @default("ltr") // 'ltr', 'rtl'
  isActive          Boolean  @default(true)
  isDefault         Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  characterTranslations CharacterTranslation[]
  lessonTranslations    LessonTranslation[]
  stepTranslations      StepTranslation[]
  contextTranslations   CulturalContextTranslation[]

  @@index([code])
  @@index([isActive, isDefault])
  @@map("languages")
}

// ============================================
// CHARACTER SYSTEM (Core of Umwero)
// ============================================

model Character {
  id                String   @id @default(cuid())
  
  // Core Identity
  umweroGlyph       String   @unique // The actual Umwero character: ", :, {, |, }
  latinEquivalent   String   // 'a', 'u', 'o', 'e', 'i'
  type              CharacterType // VOWEL, CONSONANT, LIGATURE, COMPOUND
  
  // Learning Metadata
  difficulty        Int      @default(1) // 1-5
  strokeCount       Int      @default(1)
  order             Int      // Global learning sequence
  
  // Media Assets
  glyphImageUrl     String?  // High-res PNG/SVG
  audioUrl          String?  // Pronunciation
  videoUrl          String?  // Stroke demonstration
  
  // Cultural Significance
  symbolism         String?  @db.Text // What it represents
  historicalNote    String?  @db.Text // Preservation context
  
  // System
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  translations      CharacterTranslation[]
  strokeData        StrokeData[]
  lessons           Lesson[]
  culturalContexts  CulturalContext[]
  userAttempts      UserAttempt[]

  @@index([type, order])
  @@index([latinEquivalent])
  @@index([isActive])
  @@map("characters")
}

enum CharacterType {
  VOWEL
  CONSONANT
  LIGATURE
  COMPOUND
  SPECIAL
}

model CharacterTranslation {
  id             String   @id @default(cuid())
  characterId    String
  languageId     String
  
  // Translated Fields
  name           String   // "Vowel A", "Igihango A"
  pronunciation  String   // "/a/ as in father", "/a/ nka muri se"
  meaning        String   @db.Text // "Represents cows", "Bisobanura inka"
  description    String?  @db.Text // Extended explanation
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  character      Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  language       Language  @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@unique([characterId, languageId])
  @@index([characterId])
  @@index([languageId])
  @@map("character_translations")
}

// ============================================
// STROKE ORDER SYSTEM
// ============================================

model StrokeData {
  id           String   @id @default(cuid())
  characterId  String
  
  // Stroke Definition
  strokeNumber Int      // 1, 2, 3...
  pathData     String   @db.Text // SVG path definition
  direction    StrokeDirection
  
  // Animation
  duration     Int      @default(1000) // milliseconds
  easing       String   @default("ease-in-out")
  
  // Hints
  hint         String?  // "Start from top-left"
  
  createdAt    DateTime @default(now())

  // Relations
  character    Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([characterId, strokeNumber])
  @@index([characterId, strokeNumber])
  @@map("stroke_data")
}

enum StrokeDirection {
  TOP_TO_BOTTOM
  BOTTOM_TO_TOP
  LEFT_TO_RIGHT
  RIGHT_TO_LEFT
  CLOCKWISE
  COUNTERCLOCKWISE
  DIAGONAL
}

// ============================================
// CULTURAL CONTEXT SYSTEM
// ============================================

model CulturalContext {
  id            String   @id @default(cuid())
  characterId   String
  
  // Context Type
  contextType   ContextType
  
  // Content
  icon          String?  // Material icon name
  imageUrl      String?  // Supporting image
  
  // System
  order         Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  translations  CulturalContextTranslation[]
  examples      ContextExample[]

  @@index([characterId, contextType])
  @@index([isActive])
  @@map("cultural_contexts")
}

enum ContextType {
  ETYMOLOGY      // Word origin
  CULTURAL_USE   // Traditional usage
  PRESERVATION   // Endangered status
  MEANING        // Symbolic meaning
  HISTORY        // Historical context
}

model CulturalContextTranslation {
  id              String   @id @default(cuid())
  contextId       String
  languageId      String
  
  // Translated Content
  title           String
  content         String   @db.Text
  summary         String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  context         CulturalContext @relation(fields: [contextId], references: [id], onDelete: Cascade)
  language        Language        @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@unique([contextId, languageId])
  @@index([contextId])
  @@index([languageId])
  @@map("cultural_context_translations")
}

model ContextExample {
  id              String   @id @default(cuid())
  contextId       String
  
  // Example Word
  wordUmwero      String   // Word in Umwero script
  wordLatin       String   // Romanized version
  wordEnglish     String   // English translation
  
  // Media
  audioUrl        String?
  icon            String?  // Material icon
  
  // Display
  order           Int      @default(0)
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())

  // Relations
  context         CulturalContext @relation(fields: [contextId], references: [id], onDelete: Cascade)

  @@index([contextId, order])
  @@map("context_examples")
}

// ============================================
// LESSON SYSTEM
// ============================================

model Lesson {
  id              String   @id @default(cuid())
  
  // Core Identity
  code            String   @unique // 'vowel-a', 'consonant-b'
  type            LessonType
  characterId     String?  // Primary character
  
  // Metadata
  module          String   // 'Vowels', 'Consonants', 'Ligatures'
  difficulty      Int      @default(1) // 1-5
  order           Int      // Sequence in module
  estimatedTime   Int      @default(15) // minutes
  
  // Prerequisites
  prerequisiteIds String[] // Array of lesson IDs
  
  // Publishing
  isPublished     Boolean  @default(false)
  publishedAt     DateTime?
  
  // System
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  character       Character? @relation(fields: [characterId], references: [id])
  translations    LessonTranslation[]
  steps           LessonStep[]
  progress        LessonProgress[]

  @@index([type, module, order])
  @@index([characterId])
  @@index([isPublished])
  @@map("lessons")
}

enum LessonType {
  CHARACTER_INTRO
  PRACTICE
  REVIEW
  ASSESSMENT
  CULTURAL_DEEP_DIVE
}

model LessonTranslation {
  id              String   @id @default(cuid())
  lessonId        String
  languageId      String
  
  // Translated Fields
  title           String
  description     String   @db.Text
  objectives      String[] // Learning objectives
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  lesson          Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  language        Language @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@unique([lessonId, languageId])
  @@index([lessonId])
  @@index([languageId])
  @@map("lesson_translations")
}

// ============================================
// LESSON STEP SYSTEM (Modular & Reusable)
// ============================================

model LessonStep {
  id              String   @id @default(cuid())
  lessonId        String
  
  // Step Identity
  stepType        StepType
  order           Int      // Sequence within lesson
  
  // Configuration (JSON for flexibility)
  config          Json     // Type-specific configuration
  
  // Progression
  isRequired      Boolean  @default(true)
  passingScore    Int?     // For practice/assessment steps
  
  // System
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  lesson          Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  translations    StepTranslation[]
  attempts        UserAttempt[]

  @@index([lessonId, order])
  @@index([stepType])
  @@map("lesson_steps")
}

enum StepType {
  CHARACTER_OVERVIEW
  CULTURAL_CONTEXT
  PRONUNCIATION_GUIDE
  STROKE_ORDER
  PRACTICE_CANVAS
  AI_COMPARISON
  QUIZ
  REVIEW
  SUCCESS_CELEBRATION
}

model StepTranslation {
  id              String   @id @default(cuid())
  stepId          String
  languageId      String
  
  // Translated Fields
  title           String
  instructions    String?  @db.Text
  tips            String[] // Contextual hints
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  step            LessonStep @relation(fields: [stepId], references: [id], onDelete: Cascade)
  language        Language   @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@unique([stepId, languageId])
  @@index([stepId])
  @@index([languageId])
  @@map("step_translations")
}

// ============================================
// USER PROGRESS & ATTEMPTS
// ============================================

model LessonProgress {
  id              String   @id @default(cuid())
  userId          String
  lessonId        String
  
  // Progress Tracking
  status          ProgressStatus @default(NOT_STARTED)
  currentStepId   String?
  completedSteps  String[]  // Array of step IDs
  
  // Performance
  bestScore       Int       @default(0)
  attempts        Int       @default(0)
  timeSpent       Int       @default(0) // seconds
  
  // Timestamps
  startedAt       DateTime?
  completedAt     DateTime?
  lastAccessedAt  DateTime  @default(now())
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson          Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId, status])
  @@index([lessonId])
  @@map("lesson_progress")
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  MASTERED
}

model UserAttempt {
  id              String   @id @default(cuid())
  userId          String
  stepId          String
  characterId     String?
  
  // Attempt Data
  attemptType     AttemptType
  drawingData     String?  @db.Text // Base64 image
  answer          Json?    // For quiz/assessment
  
  // AI Evaluation
  aiScore         Int?     // 0-100
  aiMetrics       Json?    // Detailed metrics
  feedback        String?  @db.Text
  
  // Performance
  timeSpent       Int      @default(0) // seconds
  isCorrect       Boolean  @default(false)
  
  // Timestamps
  createdAt       DateTime @default(now())

  // Relations
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  step            LessonStep @relation(fields: [stepId], references: [id], onDelete: Cascade)
  character       Character? @relation(fields: [characterId], references: [id])

  @@index([userId, createdAt])
  @@index([stepId])
  @@index([characterId])
  @@map("user_attempts")
}

enum AttemptType {
  DRAWING
  QUIZ
  PRONUNCIATION
  WRITING
}

// ============================================
// ACHIEVEMENT SYSTEM
// ============================================

model Achievement {
  id              String   @id @default(cuid())
  
  // Achievement Identity
  code            String   @unique // 'vowel-master', 'first-steps'
  category        AchievementCategory
  
  // Requirements
  requirement     Json     // Flexible requirement definition
  points          Int      @default(0)
  
  // Display
  icon            String?  // Material icon or image
  color           String   @default("#5e2f17")
  order           Int      @default(0)
  
  // System
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  userAchievements UserAchievement[]

  @@index([category, order])
  @@index([isActive])
  @@map("achievements")
}

enum AchievementCategory {
  LESSON_COMPLETION
  PRACTICE_MASTERY
  STREAK
  CULTURAL_KNOWLEDGE
  COMMUNITY
}

model UserAchievement {
  id              String   @id @default(cuid())
  userId          String
  achievementId   String
  
  // Unlock Data
  progress        Int      @default(0) // Percentage
  isUnlocked      Boolean  @default(false)
  unlockedAt      DateTime?
  
  // System
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement     Achievement  @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId, isUnlocked])
  @@index([achievementId])
  @@map("user_achievements")
}

// ============================================
// USER SYSTEM (Existing, augmented)
// ============================================

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  name            String?
  password        String
  role            Role     @default(STUDENT)
  
  // Preferences
  preferredLanguage String @default("en")
  theme           String   @default("light")
  
  // Legacy fields for compatibility
  mobileNumber   String?           @unique
  fullName       String
  username       String            @unique
  birthday       DateTime?
  countryCode     String?            @default("RW")
  phoneNumber    String?
  avatar         String?
  bio            String?
  country        String?
  emailVerified  Boolean           @default(false)
  verificationToken String?
  verificationTokenExpiry DateTime?
  resetToken     String?
  resetTokenExpiry DateTime?
  provider       AuthProvider      @default(EMAIL)
  providerId     String?
  company        String?
  jobTitle       String?
  lastLoginAt    DateTime?
  
  // System
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  progress        LessonProgress[]
  attempts        UserAttempt[]
  achievements    UserAchievement[]
  
  // Legacy relations for compatibility
  certificates   Certificate[]
  comments       Comment[]
  discussions    Discussion[]
  donations      Donation[]
  orders         Order[]
  drawings       UserDrawing[]
  posts          CommunityPost[]
  postLikes      PostLike[]
  postComments   PostComment[]
  chatMessages   ChatMessage[]
  trainingData   TrainingData[]
  cart           Cart?

  @@index([email])
  @@index([mobileNumber])
  @@index([username])
  @@index([countryCode])
  @@index([role])
  @@index([provider])
  @@index([verificationToken])
  @@map("users")
}

enum Role {
  STUDENT
  TEACHER
  ADMIN
}

enum AuthProvider {
  EMAIL
  FACEBOOK
  TWITTER
  GOOGLE
}

// ============================================
// LEGACY MODELS (Kept for compatibility)
// ============================================

model Certificate {
  id               String   @id @default(cuid())
  userId           String
  courseName       String
  level            String
  issueDate        DateTime @default(now())
  certificateUrl   String?
  verificationCode String   @unique
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([verificationCode])
  @@map("certificates")
}

model Discussion {
  id        String    @id @default(cuid())
  userId    String
  title     String    // UTF-8, supports Umwero + Latin
  content   String    @db.Text // UTF-8, supports Umwero + Latin
  script    String    @default("latin") // "latin" | "umwero" | "mixed"
  category  String?
  mediaUrls String[]  @default([]) // Supabase URLs for media
  isPinned  Boolean   @default(false)
  views     Int       @default(0)
  likesCount Int      @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  comments  Comment[]
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([category])
  @@index([createdAt])
  @@index([script])
  @@map("discussions")
}

model Comment {
  id           String     @id @default(cuid())
  userId       String
  discussionId String
  content      String    @db.Text // UTF-8, supports Umwero + Latin
  script       String    @default("latin") // "latin" | "umwero" | "mixed"
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  discussion   Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([discussionId])
  @@index([script])
  @@map("comments")
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  items     CartItem[]
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  title     String
  price     Float
  quantity  Int      @default(1)
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

model Order {
  id            String   @id @default(cuid())
  userId        String
  status        String
  total         Float
  items         String
  paymentMethod String?
  transactionId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("orders")
}

model Donation {
  id            String   @id @default(cuid())
  userId        String
  amount        Float
  currency      String   @default("USD")
  message       String?
  isAnonymous   Boolean  @default(false)
  paymentMethod String?
  transactionId String?
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("donations")
}

model UserDrawing {
  id          String   @id @default(cuid())
  userId      String
  lessonId    String?
  vowel       String
  umweroChar  String
  drawingData String
  aiScore     Int?
  feedback    String?
  isCorrect   Boolean  @default(false)
  timeSpent   Int      @default(0)
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lessonId])
  @@index([vowel])
  @@index([createdAt])
  @@map("user_drawings")
}

// Community Posts (Twitter-like)
model CommunityPost {
  id           String        @id @default(cuid())
  userId       String
  content      String
  language     String        @default("en") // en, rw, um
  latinText    String?       // Original Latin text
  umweroText   String?       // Translated Umwero text
  imageUrl     String?       // Generated PNG image URL
  isChallenge  Boolean       @default(false)
  challengeType String?      // e.g., "translation", "writing", "quiz"
  likesCount   Int           @default(0)
  commentsCount Int          @default(0)
  sharesCount  Int           @default(0)
  views        Int           @default(0)
  isPinned     Boolean       @default(false)
  isPublic     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes        PostLike[]
  comments     PostComment[]

  @@index([userId])
  @@index([createdAt])
  @@index([isChallenge])
  @@index([isPinned])
  @@index([language])
  @@map("community_posts")
}

model PostLike {
  id        String        @id @default(cuid())
  userId    String
  postId    String
  createdAt DateTime      @default(now())
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@map("post_likes")
}

model PostComment {
  id        String        @id @default(cuid())
  userId    String
  postId    String
  content   String
  language  String        @default("en") // en, rw, um
  latinText String?
  umweroText String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([postId])
  @@index([createdAt])
  @@index([language])
  @@map("post_comments")
}

// Chat Messages (for Umwero Chat)
model ChatMessage {
  id          String   @id @default(cuid())
  userId      String
  latinText   String
  umweroText  String
  imageUrl    String?  // Generated PNG URL
  fontSize    Int      @default(24)
  shared      Boolean  @default(false)
  shareCount  Int      @default(0)
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("chat_messages")
}

// ML Training Data
model TrainingData {
  id            String   @id @default(cuid())
  userId        String?
  sourceType    DataSourceType
  sourceId      String?  // Reference to original post/message/lesson
  latinText     String
  umweroText    String?
  translatedText String? // If translated to other languages
  context       String?  // Context of the text (lesson, chat, post, etc.)
  language      String   @default("rw") // Source language
  targetLanguage String? // Target language if translation
  quality       Int?     // Quality score (1-5)
  verified      Boolean  @default(false)
  metadata      String?  // JSON metadata
  createdAt     DateTime @default(now())
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([sourceType])
  @@index([language])
  @@index([verified])
  @@index([createdAt])
  @@map("training_data")
}

enum DataSourceType {
  CHAT_MESSAGE
  COMMUNITY_POST
  POST_COMMENT
  LESSON_CONTENT
  USER_TRANSLATION
  DRAWING_FEEDBACK
  QUIZ_ANSWER
}

// Legacy Quiz system (kept for compatibility)
model Quiz {
  id           String        @id @default(cuid())
  lessonId     String
  title        String
  description  String?
  questions    String
  passingScore Int           @default(70)
  timeLimit    Int?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  attempts     QuizAttempt[]

  @@index([lessonId])
  @@map("quizzes")
}

model QuizAttempt {
  id        String   @id @default(cuid())
  userId    String
  quizId    String
  answers   String
  score     Int
  passed    Boolean
  timeSpent Int
  createdAt DateTime @default(now())
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
  @@map("quiz_attempts")
}

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String?
  entityId   String?
  metadata   String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("activity_logs")
}
