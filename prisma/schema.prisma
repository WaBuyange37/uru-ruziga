generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String            @id @default(cuid())
  email          String?
  mobileNumber   String?           @unique
  password       String?
  fullName       String?
  username       String?           @unique
  birthday       DateTime?
  countryCode     String?            @default("RW") // Default to Rwanda, track diaspora
  phoneNumber    String?
  role           UserRole          @default(USER)
  avatar         String?
  bio            String?
  country        String?
  language       String            @default("en")
  emailVerified  Boolean           @default(false)
  verificationToken String?
  verificationTokenExpiry DateTime?
  resetToken     String?
  resetTokenExpiry DateTime?
  provider       AuthProvider      @default(EMAIL)
  providerId     String?
  company        String?
  jobTitle       String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  lastLoginAt    DateTime?
  certificates   Certificate[]
  comments       Comment[]
  discussions    Discussion[]
  donations      Donation[]
  lessonProgress LessonProgress[]
  orders         Order[]
  achievements   UserAchievement[]
  drawings       UserDrawing[]
  posts          CommunityPost[]
  postLikes      PostLike[]
  postComments   PostComment[]
  chatMessages   ChatMessage[]
  trainingData   TrainingData[]
  cart           Cart?

  @@index([email])
  @@index([mobileNumber])
  @@index([username])
  @@index([countryCode])
  @@index([role])
  @@index([provider])
  @@index([verificationToken])
  @@map("users")
}

model Lesson {
  id            String           @id @default(cuid())
  title         String
  description   String?
  content       String?
  module        LessonModule     @default(BEGINNER)
  type          LessonType       @default(VOWEL)
  order         Int
  duration      Int
  videoUrl      String?
  thumbnailUrl  String?
  prerequisites String[]
  isPublished   Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  progress      LessonProgress[]
  quizzes       Quiz[]
  userDrawings  UserDrawing[]

  @@index([module, order])
  @@index([type])
  @@map("lessons")
}

model LessonProgress {
  id          String    @id @default(cuid())
  userId      String
  lessonId    String
  completed   Boolean   @default(false)
  score       Int?
  timeSpent   Int       @default(0)
  attempts    Int       @default(0)
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lesson      Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@index([completed])
  @@map("lesson_progress")
}

model UserDrawing {
  id          String   @id @default(cuid())
  userId      String
  lessonId    String?
  vowel       String
  umweroChar  String
  drawingData String
  aiScore     Int?
  feedback    String?
  isCorrect   Boolean  @default(false)
  timeSpent   Int      @default(0)
  createdAt   DateTime @default(now())
  lesson      Lesson?  @relation(fields: [lessonId], references: [id])
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lessonId])
  @@index([vowel])
  @@index([createdAt])
  @@map("user_drawings")
}

model Quiz {
  id           String        @id @default(cuid())
  lessonId     String
  title        String
  description  String?
  questions    String
  passingScore Int           @default(70)
  timeLimit    Int?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  attempts     QuizAttempt[]
  lesson       Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
  @@map("quizzes")
}

model QuizAttempt {
  id        String   @id @default(cuid())
  userId    String
  quizId    String
  answers   String
  score     Int
  passed    Boolean
  timeSpent Int
  createdAt DateTime @default(now())
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
  @@map("quiz_attempts")
}

model Achievement {
  id               String            @id @default(cuid())
  name             String            @unique
  description      String
  icon             String?
  category         String
  requirement      String
  points           Int               @default(0)
  isSecret         Boolean           @default(false)
  createdAt        DateTime          @default(now())
  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  unlockedAt    DateTime    @default(now())
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@map("user_achievements")
}

model Certificate {
  id               String   @id @default(cuid())
  userId           String
  courseName       String
  level            String
  issueDate        DateTime @default(now())
  certificateUrl   String?
  verificationCode String   @unique
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([verificationCode])
  @@map("certificates")
}

model Discussion {
  id        String    @id @default(cuid())
  userId    String
  title     String    // UTF-8, supports Umwero + Latin
  content   String    @db.Text // UTF-8, supports Umwero + Latin
  script    String    @default("latin") // "latin" | "umwero" | "mixed"
  category  String?
  mediaUrls String[]  @default([]) // Supabase URLs for media
  isPinned  Boolean   @default(false)
  views     Int       @default(0)
  likesCount Int      @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  comments  Comment[]
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([category])
  @@index([createdAt])
  @@index([script])
  @@map("discussions")
}

model Comment {
  id           String     @id @default(cuid())
  userId       String
  discussionId String
  content      String    @db.Text // UTF-8, supports Umwero + Latin
  script       String    @default("latin") // "latin" | "umwero" | "mixed"
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  discussion   Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([discussionId])
  @@index([script])
  @@map("comments")
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  items     CartItem[]
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  title     String
  price     Float
  quantity  Int      @default(1)
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

model Order {
  id            String   @id @default(cuid())
  userId        String
  status        String
  total         Float
  items         String
  paymentMethod String?
  transactionId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("orders")
}

model Donation {
  id            String   @id @default(cuid())
  userId        String
  amount        Float
  currency      String   @default("USD")
  message       String?
  isAnonymous   Boolean  @default(false)
  paymentMethod String?
  transactionId String?
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("donations")
}

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String?
  entityId   String?
  metadata   String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("activity_logs")
}

// Community Posts (Twitter-like)
model CommunityPost {
  id           String        @id @default(cuid())
  userId       String
  content      String
  language     String        @default("en") // en, rw, um
  latinText    String?       // Original Latin text
  umweroText   String?       // Translated Umwero text
  imageUrl     String?       // Generated PNG image URL
  isChallenge  Boolean       @default(false)
  challengeType String?      // e.g., "translation", "writing", "quiz"
  likesCount   Int           @default(0)
  commentsCount Int          @default(0)
  sharesCount  Int           @default(0)
  views        Int           @default(0)
  isPinned     Boolean       @default(false)
  isPublic     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes        PostLike[]
  comments     PostComment[]

  @@index([userId])
  @@index([createdAt])
  @@index([isChallenge])
  @@index([isPinned])
  @@index([language])
  @@map("community_posts")
}

model PostLike {
  id        String        @id @default(cuid())
  userId    String
  postId    String
  createdAt DateTime      @default(now())
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@map("post_likes")
}

model PostComment {
  id        String        @id @default(cuid())
  userId    String
  postId    String
  content   String
  language  String        @default("en") // en, rw, um
  latinText String?
  umweroText String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([postId])
  @@index([createdAt])
  @@index([language])
  @@map("post_comments")
}

// Chat Messages (for Umwero Chat)
model ChatMessage {
  id          String   @id @default(cuid())
  userId      String
  latinText   String
  umweroText  String
  imageUrl    String?  // Generated PNG URL
  fontSize    Int      @default(24)
  shared      Boolean  @default(false)
  shareCount  Int      @default(0)
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("chat_messages")
}

// ML Training Data
model TrainingData {
  id            String   @id @default(cuid())
  userId        String?
  sourceType    DataSourceType
  sourceId      String?  // Reference to original post/message/lesson
  latinText     String
  umweroText    String?
  translatedText String? // If translated to other languages
  context       String?  // Context of the text (lesson, chat, post, etc.)
  language      String   @default("rw") // Source language
  targetLanguage String? // Target language if translation
  quality       Int?     // Quality score (1-5)
  verified      Boolean  @default(false)
  metadata      String?  // JSON metadata
  createdAt     DateTime @default(now())
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([sourceType])
  @@index([language])
  @@index([verified])
  @@index([createdAt])
  @@map("training_data")
}

enum DataSourceType {
  CHAT_MESSAGE
  COMMUNITY_POST
  POST_COMMENT
  LESSON_CONTENT
  USER_TRANSLATION
  DRAWING_FEEDBACK
  QUIZ_ANSWER
}

enum UserRole {
  USER
  PROFESSIONAL
  ADMIN
  TEACHER
}

enum AuthProvider {
  EMAIL
  FACEBOOK
  TWITTER
  GOOGLE
}

enum LessonModule {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum LessonType {
  VOWEL
  CONSONANT
  WORD
  SENTENCE
  GRAMMAR
  CULTURE
}
