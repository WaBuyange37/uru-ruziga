generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String            @id @default(cuid())
  email          String            @unique
  password       String
  fullName       String?
  phoneNumber    String?
  role           UserRole          @default(USER)
  avatar         String?
  bio            String?
  country        String?
  language       String            @default("en")
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  lastLoginAt    DateTime?
  certificates   Certificate[]
  comments       Comment[]
  discussions    Discussion[]
  donations      Donation[]
  lessonProgress LessonProgress[]
  orders         Order[]
  achievements   UserAchievement[]
  drawings       UserDrawing[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model Lesson {
  id            String           @id @default(cuid())
  title         String
  description   String?
  content       String?
  module        LessonModule     @default(BEGINNER)
  type          LessonType       @default(VOWEL)
  order         Int
  duration      Int
  videoUrl      String?
  thumbnailUrl  String?
  prerequisites String[]
  isPublished   Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  progress      LessonProgress[]
  quizzes       Quiz[]
  userDrawings  UserDrawing[]

  @@index([module, order])
  @@index([type])
  @@map("lessons")
}

model LessonProgress {
  id          String    @id @default(cuid())
  userId      String
  lessonId    String
  completed   Boolean   @default(false)
  score       Int?
  timeSpent   Int       @default(0)
  attempts    Int       @default(0)
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lesson      Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@index([completed])
  @@map("lesson_progress")
}

model UserDrawing {
  id          String   @id @default(cuid())
  userId      String
  lessonId    String?
  vowel       String
  umweroChar  String
  drawingData String
  aiScore     Int?
  feedback    String?
  isCorrect   Boolean  @default(false)
  timeSpent   Int      @default(0)
  createdAt   DateTime @default(now())
  lesson      Lesson?  @relation(fields: [lessonId], references: [id])
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lessonId])
  @@index([vowel])
  @@index([createdAt])
  @@map("user_drawings")
}

model Quiz {
  id           String        @id @default(cuid())
  lessonId     String
  title        String
  description  String?
  questions    String
  passingScore Int           @default(70)
  timeLimit    Int?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  attempts     QuizAttempt[]
  lesson       Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
  @@map("quizzes")
}

model QuizAttempt {
  id        String   @id @default(cuid())
  userId    String
  quizId    String
  answers   String
  score     Int
  passed    Boolean
  timeSpent Int
  createdAt DateTime @default(now())
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
  @@map("quiz_attempts")
}

model Achievement {
  id               String            @id @default(cuid())
  name             String            @unique
  description      String
  icon             String?
  category         String
  requirement      String
  points           Int               @default(0)
  isSecret         Boolean           @default(false)
  createdAt        DateTime          @default(now())
  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  unlockedAt    DateTime    @default(now())
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@map("user_achievements")
}

model Certificate {
  id               String   @id @default(cuid())
  userId           String
  courseName       String
  level            String
  issueDate        DateTime @default(now())
  certificateUrl   String?
  verificationCode String   @unique
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([verificationCode])
  @@map("certificates")
}

model Discussion {
  id        String    @id @default(cuid())
  userId    String
  title     String
  content   String
  category  String?
  isPinned  Boolean   @default(false)
  views     Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  comments  Comment[]
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([category])
  @@index([createdAt])
  @@map("discussions")
}

model Comment {
  id           String     @id @default(cuid())
  userId       String
  discussionId String
  content      String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  discussion   Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([discussionId])
  @@map("comments")
}

model Order {
  id            String   @id @default(cuid())
  userId        String
  status        String
  total         Float
  items         String
  paymentMethod String?
  transactionId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("orders")
}

model Donation {
  id            String   @id @default(cuid())
  userId        String
  amount        Float
  currency      String   @default("USD")
  message       String?
  isAnonymous   Boolean  @default(false)
  paymentMethod String?
  transactionId String?
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("donations")
}

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String?
  entityId   String?
  metadata   String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("activity_logs")
}

enum UserRole {
  USER
  ADMIN
  TEACHER
}

enum LessonModule {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum LessonType {
  VOWEL
  CONSONANT
  WORD
  SENTENCE
  GRAMMAR
  CULTURE
}
