generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Language {
  id                    String                       @id @default(cuid())
  code                  String                       @unique
  name                  String
  displayName           String
  direction             String                       @default("ltr")
  isActive              Boolean                      @default(true)
  isDefault             Boolean                      @default(false)
  createdAt             DateTime                     @default(now())
  updatedAt             DateTime                     @updatedAt
  characterTranslations CharacterTranslation[]
  contextTranslations   CulturalContextTranslation[]
  lessonTranslations    LessonTranslation[]
  stepTranslations      StepTranslation[]

  @@index([code])
  @@index([isActive, isDefault])
  @@map("languages")
}

model Character {
  id               String                 @id @default(cuid())
  umweroGlyph      String                 @unique
  latinEquivalent  String
  type             CharacterType
  difficulty       Int                    @default(1)
  strokeCount      Int                    @default(1)
  order            Int
  glyphImageUrl    String?
  audioUrl         String?
  videoUrl         String?
  symbolism        String?
  historicalNote   String?
  isActive         Boolean                @default(true)
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  translations     CharacterTranslation[]
  culturalContexts CulturalContext[]
  lessons          Lesson[]
  strokeData       StrokeData[]
  userAttempts     UserAttempt[]
  userProgress     UserCharacterProgress[]

  @@index([type, order])
  @@index([latinEquivalent])
  @@index([isActive])
  @@map("characters")
}

model CharacterTranslation {
  id            String    @id @default(cuid())
  characterId   String
  languageId    String
  name          String
  pronunciation String
  meaning       String
  description   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  language      Language  @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@unique([characterId, languageId])
  @@index([characterId])
  @@index([languageId])
  @@map("character_translations")
}

model StrokeData {
  id           String          @id @default(cuid())
  characterId  String
  strokeNumber Int
  pathData     String
  direction    StrokeDirection
  duration     Int             @default(1000)
  easing       String          @default("ease-in-out")
  hint         String?
  createdAt    DateTime        @default(now())
  character    Character       @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([characterId, strokeNumber])
  @@index([characterId, strokeNumber])
  @@map("stroke_data")
}

model CulturalContext {
  id           String                       @id @default(cuid())
  characterId  String
  contextType  ContextType
  icon         String?
  imageUrl     String?
  order        Int                          @default(0)
  isActive     Boolean                      @default(true)
  createdAt    DateTime                     @default(now())
  updatedAt    DateTime                     @updatedAt
  examples     ContextExample[]
  translations CulturalContextTranslation[]
  character    Character                    @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId, contextType])
  @@index([isActive])
  @@map("cultural_contexts")
}

model CulturalContextTranslation {
  id         String          @id @default(cuid())
  contextId  String
  languageId String
  title      String
  content    String
  summary    String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  context    CulturalContext @relation(fields: [contextId], references: [id], onDelete: Cascade)
  language   Language        @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@unique([contextId, languageId])
  @@index([contextId])
  @@index([languageId])
  @@map("cultural_context_translations")
}

model ContextExample {
  id          String          @id @default(cuid())
  contextId   String
  wordUmwero  String
  wordLatin   String
  wordEnglish String
  audioUrl    String?
  icon        String?
  order       Int             @default(0)
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  context     CulturalContext @relation(fields: [contextId], references: [id], onDelete: Cascade)

  @@index([contextId, order])
  @@map("context_examples")
}

model Lesson {
  id              String              @id @default(cuid())
  title           String
  description     String?
  content         String?
  module          LessonModule        @default(BEGINNER)
  type            LessonType          @default(VOWEL)
  order           Int
  duration        Int
  videoUrl        String?
  thumbnailUrl    String?
  prerequisites   String[]
  code            String?             @unique
  characterId     String?
  difficulty      Int                 @default(1)
  estimatedTime   Int?
  prerequisiteIds String[]            @default([])
  isPublished     Boolean             @default(false)
  publishedAt     DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  progress        LessonProgress[]
  steps           LessonStep[]
  translations    LessonTranslation[]
  character       Character?          @relation(fields: [characterId], references: [id])

  @@index([type, module, order])
  @@index([module, order])
  @@index([characterId])
  @@index([isPublished])
  @@map("lessons")
}

model LessonTranslation {
  id          String   @id @default(cuid())
  lessonId    String
  languageId  String
  title       String
  description String
  objectives  String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  language    Language @relation(fields: [languageId], references: [id], onDelete: Cascade)
  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([lessonId, languageId])
  @@index([lessonId])
  @@index([languageId])
  @@map("lesson_translations")
}

model LessonStep {
  id           String            @id @default(cuid())
  lessonId     String
  stepType     StepType
  order        Int
  config       Json
  isRequired   Boolean           @default(true)
  passingScore Int?
  isActive     Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  lesson       Lesson            @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  translations StepTranslation[]
  attempts     UserAttempt[]

  @@index([lessonId, order])
  @@index([stepType])
  @@map("lesson_steps")
}

model StepTranslation {
  id           String     @id @default(cuid())
  stepId       String
  languageId   String
  title        String
  instructions String?
  tips         String[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  language     Language   @relation(fields: [languageId], references: [id], onDelete: Cascade)
  step         LessonStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@unique([stepId, languageId])
  @@index([stepId])
  @@index([languageId])
  @@map("step_translations")
}

model LessonProgress {
  id             String         @id @default(cuid())
  userId         String
  lessonId       String
  completed      Boolean        @default(false)
  score          Int?
  timeSpent      Int            @default(0)
  attempts       Int            @default(0)
  completedAt    DateTime?
  status         ProgressStatus @default(NOT_STARTED)
  currentStepId  String?
  completedSteps String[]       @default([])
  bestScore      Int            @default(0)
  startedAt      DateTime?
  lastAccessedAt DateTime       @default(now())
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  lesson         Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId, status])
  @@index([userId, completed])
  @@index([lessonId])
  @@map("lesson_progress")
}

model UserAttempt {
  id               String      @id @default(cuid())
  userId           String
  stepId           String
  characterId      String?
  attemptType      AttemptType
  drawingData      String?
  answer           Json?
  aiScore          Int?
  aiMetrics        Json?
  feedback         String?
  confidenceScore  Float?
  evaluationType   String?
  uploadedImageUrl String?
  timeSpent        Int         @default(0)
  isCorrect        Boolean     @default(false)
  createdAt        DateTime    @default(now())
  character        Character?  @relation(fields: [characterId], references: [id])
  step             LessonStep  @relation(fields: [stepId], references: [id], onDelete: Cascade)
  user             User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([stepId])
  @@index([characterId])
  @@map("user_attempts")
}

model Achievement {
  id               String              @id @default(cuid())
  code             String              @unique
  name             String
  description      String
  category         AchievementCategory
  requirement      Json
  points           Int                 @default(0)
  icon             String?
  color            String              @default("#5e2f17")
  order            Int                 @default(0)
  isActive         Boolean             @default(true)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  userAchievements UserAchievement[]

  @@index([category, order])
  @@index([isActive])
  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  progress      Int         @default(0)
  isUnlocked    Boolean     @default(false)
  unlockedAt    DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId, isUnlocked])
  @@index([achievementId])
  @@map("user_achievements")
}

model User {
  id                      String            @id @default(cuid())
  email                   String            @unique
  name                    String?
  password                String
  role                    Role              @default(STUDENT)
  preferredLanguage       String            @default("en")
  theme                   String            @default("light")
  mobileNumber            String?           @unique
  fullName                String
  username                String            @unique
  birthday                DateTime?
  countryCode             String?           @default("RW")
  phoneNumber             String?
  avatar                  String?
  bio                     String?
  country                 String?
  emailVerified           Boolean           @default(false)
  verificationToken       String?
  verificationTokenExpiry DateTime?
  resetToken              String?
  resetTokenExpiry        DateTime?
  provider                AuthProvider      @default(EMAIL)
  providerId              String?
  company                 String?
  jobTitle                String?
  lastLoginAt             DateTime?
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  cart                    Cart?
  certificates            Certificate[]
  chatMessages            ChatMessage[]
  comments                Comment[]
  posts                   CommunityPost[]
  discussionLikes         DiscussionLike[]
  discussions             Discussion[]
  donations               Donation[]
  progress                LessonProgress[]
  orders                  Order[]
  postComments            PostComment[]
  postLikes               PostLike[]
  trainingData            TrainingData[]
  achievements            UserAchievement[]
  attempts                UserAttempt[]
  drawings                UserDrawing[]
  characterProgress       UserCharacterProgress[]

  @@index([email])
  @@index([mobileNumber])
  @@index([username])
  @@index([countryCode])
  @@index([role])
  @@index([provider])
  @@index([verificationToken])
  @@map("users")
}

model UserCharacterProgress {
  id          String                    @id @default(cuid())
  userId      String
  characterId String
  status      CharacterProgressStatus   @default(NOT_STARTED)
  score       Int                       @default(0)
  timeSpent   Int                       @default(0) // in seconds
  attempts    Int                       @default(0)
  lastAttempt DateTime?
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt
  user        User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  character   Character                 @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([userId, characterId])
  @@index([userId])
  @@index([characterId])
  @@index([status])
  @@map("user_character_progress")
}

model Certificate {
  id               String   @id @default(cuid())
  userId           String
  courseName       String
  level            String
  issueDate        DateTime @default(now())
  certificateUrl   String?
  verificationCode String   @unique
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([verificationCode])
  @@map("certificates")
}

model Discussion {
  id         String           @id @default(cuid())
  userId     String
  title      String
  content    String
  script     String           @default("latin")
  category   String?
  mediaUrls  String[]         @default([])
  isPinned   Boolean          @default(false)
  views      Int              @default(0)
  likesCount Int              @default(0)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  comments   Comment[]
  likes      DiscussionLike[]
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([category])
  @@index([createdAt])
  @@index([script])
  @@map("discussions")
}

model DiscussionLike {
  id           String     @id @default(cuid())
  userId       String
  discussionId String
  createdAt    DateTime   @default(now())
  discussion   Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, discussionId])
  @@index([userId])
  @@index([discussionId])
  @@map("discussion_likes")
}

model Comment {
  id           String     @id @default(cuid())
  userId       String
  discussionId String
  content      String
  script       String     @default("latin")
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  discussion   Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([discussionId])
  @@index([script])
  @@map("comments")
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  items     CartItem[]
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  title     String
  price     Float
  quantity  Int      @default(1)
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

model Order {
  id            String   @id @default(cuid())
  userId        String
  status        String
  total         Float
  items         String
  paymentMethod String?
  transactionId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("orders")
}

model Donation {
  id            String   @id @default(cuid())
  userId        String
  amount        Float
  currency      String   @default("USD")
  message       String?
  isAnonymous   Boolean  @default(false)
  paymentMethod String?
  transactionId String?
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("donations")
}

model UserDrawing {
  id          String   @id @default(cuid())
  userId      String
  lessonId    String?
  vowel       String
  umweroChar  String
  drawingData String
  aiScore     Int?
  feedback    String?
  isCorrect   Boolean  @default(false)
  timeSpent   Int      @default(0)
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lessonId])
  @@index([vowel])
  @@index([createdAt])
  @@map("user_drawings")
}

model CommunityPost {
  id            String        @id @default(cuid())
  userId        String
  content       String
  language      String        @default("en")
  latinText     String?
  umweroText    String?
  imageUrl      String?
  isChallenge   Boolean       @default(false)
  challengeType String?
  likesCount    Int           @default(0)
  commentsCount Int           @default(0)
  sharesCount   Int           @default(0)
  views         Int           @default(0)
  isPinned      Boolean       @default(false)
  isPublic      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  mediaUrls     String[]
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments      PostComment[]
  likes         PostLike[]

  @@index([userId])
  @@index([createdAt])
  @@index([isChallenge])
  @@index([isPinned])
  @@index([language])
  @@map("community_posts")
}

model PostLike {
  id        String        @id @default(cuid())
  userId    String
  postId    String
  createdAt DateTime      @default(now())
  post      CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@map("post_likes")
}

model PostComment {
  id         String        @id @default(cuid())
  userId     String
  postId     String
  content    String
  language   String        @default("en")
  latinText  String?
  umweroText String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  post       CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([postId])
  @@index([createdAt])
  @@index([language])
  @@map("post_comments")
}

model ChatMessage {
  id         String   @id @default(cuid())
  userId     String
  latinText  String
  umweroText String
  imageUrl   String?
  fontSize   Int      @default(24)
  shared     Boolean  @default(false)
  shareCount Int      @default(0)
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("chat_messages")
}

model TrainingData {
  id             String         @id @default(cuid())
  userId         String?
  sourceType     DataSourceType
  sourceId       String?
  latinText      String
  umweroText     String?
  translatedText String?
  context        String?
  language       String         @default("rw")
  targetLanguage String?
  quality        Int?
  verified       Boolean        @default(false)
  metadata       String?
  createdAt      DateTime       @default(now())
  user           User?          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([sourceType])
  @@index([language])
  @@index([verified])
  @@index([createdAt])
  @@map("training_data")
}

model Quiz {
  id           String        @id @default(cuid())
  lessonId     String
  title        String
  description  String?
  questions    String
  passingScore Int           @default(70)
  timeLimit    Int?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  attempts     QuizAttempt[]

  @@index([lessonId])
  @@map("quizzes")
}

model QuizAttempt {
  id        String   @id @default(cuid())
  userId    String
  quizId    String
  answers   String
  score     Int
  passed    Boolean
  timeSpent Int
  createdAt DateTime @default(now())
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
  @@map("quiz_attempts")
}

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String?
  entityId   String?
  metadata   String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("activity_logs")
}

enum CharacterType {
  VOWEL
  CONSONANT
  LIGATURE
  COMPOUND
  SPECIAL
}

enum StrokeDirection {
  TOP_TO_BOTTOM
  BOTTOM_TO_TOP
  LEFT_TO_RIGHT
  RIGHT_TO_LEFT
  CLOCKWISE
  COUNTERCLOCKWISE
  DIAGONAL
}

enum ContextType {
  ETYMOLOGY
  CULTURAL_USE
  PRESERVATION
  MEANING
  HISTORY
}

enum LessonModule {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum LessonType {
  VOWEL
  CONSONANT
  WORD
  SENTENCE
  GRAMMAR
  CULTURE
  CHARACTER_INTRO
  PRACTICE
  REVIEW
  ASSESSMENT
  CULTURAL_DEEP_DIVE
  LIGATURE
}

enum StepType {
  CHARACTER_OVERVIEW
  CULTURAL_CONTEXT
  PRONUNCIATION_GUIDE
  STROKE_ORDER
  PRACTICE_CANVAS
  AI_COMPARISON
  QUIZ
  REVIEW
  SUCCESS_CELEBRATION
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  MASTERED
}

enum CharacterProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  LEARNED
}

enum AttemptType {
  DRAWING
  QUIZ
  PRONUNCIATION
  WRITING
}

enum AchievementCategory {
  LESSON_COMPLETION
  PRACTICE_MASTERY
  STREAK
  CULTURAL_KNOWLEDGE
  COMMUNITY
}

enum Role {
  USER
  STUDENT
  TEACHER
  ADMIN
}

enum AuthProvider {
  EMAIL
  FACEBOOK
  TWITTER
  GOOGLE
}

enum DataSourceType {
  CHAT_MESSAGE
  COMMUNITY_POST
  POST_COMMENT
  LESSON_CONTENT
  USER_TRANSLATION
  DRAWING_FEEDBACK
  QUIZ_ANSWER
}
